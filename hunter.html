<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Streamer Hunt ‚Äì Hunter View</title>

<style>
html, body, #map {
  width: 100%;
  height: 100%;
  margin: 0;
  background: #000;
}

#next-update-box {
  position: absolute;
  top: 10px;
  left: 10px;
  background: rgba(0,0,0,0.6);
  padding: 8px 14px;
  color: #6bd4ff;
  font-size: 16px;
  font-weight: bold;
  border-radius: 8px;
  z-index: 3000;
}

#paused-overlay {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: rgba(0,0,0,0.7);
  padding: 20px 50px;
  font-size: 42px;
  font-weight: bold;
  border-radius: 12px;
  color: #fff;
  display: none;
  z-index: 4000;
}

</style>
</head>
<body>
<div id="paused-overlay">GAME PAUSED</div>


<div id="map"></div>
<div id="next-update-box">--:--</div>

<script>
let map;
let config;
let runnerMarker;
let roundStart;
let revealAtSec;
let intervalSec;
let cameraInitialized = false;
let gameStatus = "paused";

// üîÅ Config + State laden
Promise.all([
  fetch("api.php?action=config").then(r => r.json()),
  fetch("api.php?action=state").then(r => r.json())
]).then(([cfg, state]) => {
  config = cfg;
  roundStart = state.round_start;

  revealAtSec = roundStart + (config.runner_runtime_minutes * 60);
  intervalSec = config.position_frequency_minutes * 60;

  const script = document.createElement("script");
  script.src =
    "https://maps.googleapis.com/maps/api/js?key=" +
    cfg.google_maps_key +
    "&callback=initMap";
  script.async = true;
  document.head.appendChild(script);
});

// üîÅ Game State pollen (f√ºr Pause-Overlay)
function pollGameState() {
  fetch("api.php?action=state&_=" + Date.now())
    .then(r => r.json())
    .then(state => {
      gameStatus = state.status;

      const overlay = document.getElementById("paused-overlay");

      if (gameStatus === "paused") {
        overlay.style.display = "block";

        // Marker ausblenden, Kamera zur√ºcksetzen
        if (runnerMarker) runnerMarker.setMap(null);
        cameraInitialized = false;
      } else {
        overlay.style.display = "none";
      }
    });
}

setInterval(pollGameState, 2000);
pollGameState();


function initMap() {
  map = new google.maps.Map(document.getElementById("map"), {
    center: { lat: config.lat, lng: config.lng },
    zoom: config.zoom ?? 14,
    disableDefaultUI: true
  });

  runnerMarker = new google.maps.Marker({
    map: null,
    icon: {
      path: "M -10,0 L 10,0 M 0,-10 L 0,10",
      strokeColor: "#FF0000",
      strokeWeight: 3
    }
  });

  loadSnapshot();
  setInterval(loadSnapshot, 5000);
  setInterval(updateTimer, 1000);
}

// üìç Snapshot laden (NIE Live!)
function loadSnapshot() {
  if (gameStatus !== "running") return;

  fetch("api.php?action=runner_snapshot&_=" + Date.now())
    .then(r => r.json())
    .then(snap => {
      if (!snap || snap.lat === null) return;

      const pos = { lat: snap.lat, lng: snap.lng };
      runnerMarker.setPosition(pos);
      runnerMarker.setMap(map);

      if (!cameraInitialized) {
        map.setCenter(pos);
        map.setZoom(18);
        cameraInitialized = true;
      } else {
        map.panTo(pos);
      }
    });
}



// ‚è± Countdown
function updateTimer() {
  const box = document.getElementById("next-update-box");

  // ‚õî Bei Pause komplett ausblenden
  if (gameStatus !== "running") {
    box.style.display = "none";
    return;
  }

  const now = Math.floor(Date.now() / 1000);

  // ‚è≥ Vor Reveal
  if (now < revealAtSec) {
    const left = revealAtSec - now;
    box.textContent =
      `Reveal in ${Math.floor(left/60)}:${String(left%60).padStart(2,"0")}`;
    box.style.display = "block";
    return;
  }

  // üîÅ N√§chster Slot
  const elapsed = now - revealAtSec;
  const untilNext = intervalSec - (elapsed % intervalSec);

  box.textContent =
    `Next update in ${Math.floor(untilNext/60)}:${String(untilNext%60).padStart(2,"0")}`;
  box.style.display = "block";
}

</script>

</body>
</html>
